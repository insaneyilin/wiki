<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
    <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Python 中的模块 - Yilin's Wiki</title>
    <meta name="keywords" content=""/>
    <meta name="description" content=""/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
          <!--$表示行内元素，$$表示块状元素 -->
          inlineMath: [ ['$','$'], ["\\(","\\)"] ],
          displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        },
        "HTML-CSS": { availableFonts: ["TeX"] }
      });
    </script>
    <script type="text/javascript" async
      src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>

    <!--Mermaid流程图-->
    <script src="https://cdn.bootcss.com/mermaid/8.0.0-rc.8/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad:true});</script>
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/wiki/">Home</a>&nbsp;&#187;&nbsp;<a href="/wiki/#python">python</a>&nbsp;&#187;&nbsp;Python 中的模块
    <span class="updated">Page Updated&nbsp;
      2019-11-09 11:01
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Python 中的模块</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">使用模块</a></li>
<li><a href="#_2">安装第三方模块</a></li>
<li><a href="#_3">模块搜索路径</a></li>
<li><a href="#python">Python 常用内建模块</a><ul>
<li><a href="#datetime">datetime</a></li>
<li><a href="#collections">collections</a><ul>
<li><a href="#namedtuple">namedtuple</a></li>
<li><a href="#deque">deque</a></li>
<li><a href="#defaultdict">defaultdict</a></li>
<li><a href="#ordereddict">OrderedDict</a></li>
<li><a href="#chainmap">ChainMap</a></li>
<li><a href="#counter">Counter</a></li>
</ul>
</li>
<li><a href="#base64">base64</a></li>
<li><a href="#struct">struct</a></li>
<li><a href="#hashlib">hashlib</a></li>
<li><a href="#hmac">hmac</a></li>
<li><a href="#itertools">itertools</a></li>
<li><a href="#contextlib">contextlib</a><ul>
<li><a href="#contextmanager">@contextmanager</a></li>
<li><a href="#closing">@closing</a></li>
</ul>
</li>
<li><a href="#urllib">urllib</a><ul>
<li><a href="#get">Get</a></li>
<li><a href="#post">Post</a></li>
<li><a href="#handler">Handler</a></li>
</ul>
</li>
<li><a href="#xml">xml</a></li>
<li><a href="#htmlparser">HTMLParser</a></li>
</ul>
</li>
<li><a href="#_4">常用第三方模块</a><ul>
<li><a href="#pillow">Pillow</a></li>
<li><a href="#requests">requests</a></li>
<li><a href="#chardet">chardet</a></li>
<li><a href="#psutil">psutil</a></li>
</ul>
</li>
</ul>
</div>
<p>参考自 <a href="https://www.liaoxuefeng.com/wiki/1016959663602400">廖雪峰Python教程</a></p>
<h2 id="_1">使用模块</h2>
<p>自定义一个模块：</p>
<table class="hlcodetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="hlcode"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="s1">&#39;hello.py: a test module&#39;</span>
<span class="c1"># 任何模块代码的第一个字符串都被视为模块的文档注释</span>
<span class="c1"># 文档注释可以用特殊变量 __doc__ 访问</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s1">&#39;no one&#39;</span>  <span class="c1"># 作者</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello, world!&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Hello, </span><span class="si">%s</span><span class="s1">!&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Too many arguments!&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">test</span><span class="p">()</span>
</pre></div>
</td></tr></table>

<p>类似 <code>_xxx</code> 和 <code>__xxx</code> 这样的函数或变量就是非公开的（private），不应该被直接引用，比如 <code>_abc</code> ，<code>__abc</code> 等；Python并没有一种方法可以完全限制访问private函数或变量，这只是编程规范。</p>
<h2 id="_2">安装第三方模块</h2>
<p>通过包管理工具 <code>pip</code> 完成。</p>
<p>一般来说，第三方库都会在Python官方的pypi.python.org网站注册。</p>
<div class="hlcode"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">&lt;</span><span class="n">package</span><span class="o">&gt;</span>
<span class="o">#</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">&lt;</span><span class="n">package</span><span class="o">&gt;</span>
</pre></div>


<p>或者使用 <a href="https://www.anaconda.com/">Anaconda</a> 进行管理。</p>
<h2 id="_3">模块搜索路径</h2>
<p>当加载一个模块时，Python会在指定路径下搜索对应的 <code>.py</code> 文件，如果找不到，就会报错。</p>
<p>默认情况下，Python解释器会搜索当前目录、所有已安装的内置模块和第三方模块，搜索路径存放在 <code>sys</code> 模块的 <code>path</code> 变量中：</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="k">print</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</pre></div>


<p>添加自己的搜索目录，有两种方法：</p>
<ol>
<li>直接修改 <code>sys.path</code>：<code>sys.path.append('/home/user/my_py_codes')</code></li>
<li>设置环境变量 <code>PYTHONPATH</code>: <code>export PYTHONPATH=...</code></li>
</ol>
<hr />
<h2 id="python">Python 常用内建模块</h2>
<p>Python 内置了很多非常有用的模块。</p>
<h3 id="datetime">datetime</h3>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># 获取当前日期和时间</span>
<span class="k">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="c1"># 2019-11-09 10:41:06.959435</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">now</span><span class="p">))</span>
<span class="c1"># &lt;class &#39;datetime.datetime&#39;&gt;</span>

<span class="c1"># 获取指定日期和时间</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2017</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span> <span class="c1"># 用指定日期时间创建 datetime</span>
<span class="k">print</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>  <span class="c1"># 2017-04-19 10:30:00</span>

<span class="c1"># datetime转换为timestamp</span>
<span class="c1"># 我们把1970年1月1日 00:00:00 UTC+00:00时区的时刻称为epoch time，</span>
<span class="c1"># 记为0（1970年以前的时间timestamp为负数），当前时间就是相对于</span>
<span class="c1"># epoch time的秒数，称为timestamp。</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2019</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span> <span class="c1"># 用指定日期时间创建 datetime</span>
<span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">timestamp</span><span class="p">()))</span>  <span class="c1"># 1571452225.0</span>

<span class="c1"># 时间戳转 datetime</span>
<span class="n">t</span> <span class="o">=</span> <span class="mf">1571452225.0</span>
<span class="k">print</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

<span class="c1"># str转换为datetime</span>
<span class="c1"># 注意转换后的datetime是没有时区信息的</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s1">&#39;2015-6-1 18:19:59&#39;</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>

<span class="c1"># datetime 转 str</span>
<span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
</pre></div>


<p>datetime加减，借助于 <code>datetime.timedelta</code>：</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
<span class="n">now</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">now</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>


<p>时区转换：</p>
<div class="hlcode"><pre><span></span><span class="c1"># 我们可以先通过utcnow()拿到当前的UTC时间，再转换为任意时区的时间</span>

<span class="c1"># 拿到UTC时间，并强制设置时区为UTC+0:00:</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">utc_dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">utc_dt</span><span class="p">)</span>
<span class="mi">2015</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">18</span> <span class="mi">09</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mf">12.377316</span><span class="o">+</span><span class="mo">00</span><span class="p">:</span><span class="mo">00</span>

<span class="c1"># astimezone()将转换时区为北京时间:</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">bj_dt</span> <span class="o">=</span> <span class="n">utc_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">8</span><span class="p">)))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">bj_dt</span><span class="p">)</span>
<span class="mi">2015</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">18</span> <span class="mi">17</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mf">12.377316</span><span class="o">+</span><span class="mi">08</span><span class="p">:</span><span class="mo">00</span>

<span class="c1"># astimezone()将转换时区为东京时间:</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tokyo_dt</span> <span class="o">=</span> <span class="n">utc_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">9</span><span class="p">)))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">tokyo_dt</span><span class="p">)</span>
<span class="mi">2015</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">18</span> <span class="mi">18</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mf">12.377316</span><span class="o">+</span><span class="mi">09</span><span class="p">:</span><span class="mo">00</span>

<span class="c1"># astimezone()将bj_dt转换时区为东京时间:</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">tokyo_dt2</span> <span class="o">=</span> <span class="n">bj_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">timezone</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">9</span><span class="p">)))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">tokyo_dt2</span><span class="p">)</span>
<span class="mi">2015</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">18</span> <span class="mi">18</span><span class="p">:</span><span class="mo">05</span><span class="p">:</span><span class="mf">12.377316</span><span class="o">+</span><span class="mi">09</span><span class="p">:</span><span class="mo">00</span>
</pre></div>


<h3 id="collections">collections</h3>
<p><code>collections</code> 提供了很多有用的集合类（类似 C++ 中的容器）。</p>
<h4 id="namedtuple">namedtuple</h4>
<p><code>namedtuple</code>，用来创建一个自定义的tuple对象，并且规定了tuple元素的个数，并可以用属性而不是索引来引用tuple的某个元素。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>

<span class="n">Point</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Point&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="n">pt</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

<span class="c1"># namedtuple 是 tuple 的子类</span>
<span class="nb">isinstance</span><span class="p">(</span><span class="n">pt</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>  <span class="c1"># True</span>
</pre></div>


<h4 id="deque">deque</h4>
<p><code>deque</code>，使用 <code>list</code> 存储数据时，按索引访问元素很快，但是插入和删除元素就很慢了，因为 <code>list</code> 是线性存储，数据量大的时候，插入和删除效率很低。 <code>deque</code> 是为了高效实现插入和删除操作的双向列表，适合用于队列和栈：</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>

<span class="n">q</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">])</span>
<span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
<span class="n">q</span><span class="o">.</span><span class="n">appendleft</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
</pre></div>


<h4 id="defaultdict">defaultdict</h4>
<p><code>defaultdict</code>，使用 <code>dict</code> 时，如果引用的Key不存在，就会抛出KeyError。如果希望 <code>key</code> 不存在时，返回一个默认值，就可以用 <code>defaultdict</code>:</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="s1">&#39;N/A&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;new_key&#39;</span><span class="p">])</span>  <span class="c1"># &#39;N/A&#39;</span>
</pre></div>


<h4 id="ordereddict">OrderedDict</h4>
<p><code>OrderedDict</code>, 使用 <code>dict</code> 时，Key是无序的。在对 <code>dict</code> 做迭代时，我们无法确定Key的顺序。如果要保持Key的顺序，可以用 <code>OrderedDict</code>：</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>

<span class="n">d</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
<span class="n">od</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">od</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">od</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="nb">list</span><span class="p">(</span><span class="n">od</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="c1"># 按照插入的Key的顺序返回</span>
<span class="c1"># [&#39;z&#39;, &#39;y&#39;, &#39;x&#39;]</span>
</pre></div>


<h4 id="chainmap">ChainMap</h4>
<p><code>ChainMap</code> 可以把一组 <code>dict</code> 串起来并组成一个逻辑上的 <code>dict</code> 。 <code>ChainMap</code> 本身也是一个 <code>dict</code> ，但是查找的时候，会按照顺序在内部的 <code>dict</code> 依次查找。</p>
<p>什么时候使用 <code>ChainMap</code> 最合适？举个例子：应用程序往往都需要传入参数，参数可以通过命令行传入，可以通过环境变量传入，还可以有默认参数。我们可以用ChainMap实现参数的优先级查找，即先查命令行参数，如果没有传入，再查环境变量，如果没有，就使用默认参数。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>

<span class="n">d1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="n">d2</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">}</span>

<span class="n">cmap</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">ChainMap</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
<span class="c1"># ChainMap({&#39;a&#39;: 1, &#39;b&#39;: 2}, {&#39;a&#39;: 0, &#39;b&#39;: 3, &#39;c&#39;: 9})</span>
<span class="k">print</span><span class="p">(</span><span class="n">cmap</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">])</span>  <span class="c1"># 1</span>
<span class="k">print</span><span class="p">(</span><span class="n">cmap</span><span class="p">[</span><span class="s1">&#39;c&#39;</span><span class="p">])</span>  <span class="c1"># 9</span>
</pre></div>


<h4 id="counter">Counter</h4>
<p>一个简单的计数器，例如，统计字符出现的个数：</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">collections</span>

<span class="n">counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span>
<span class="c1"># Counter 实际上是 dict 的一个子类</span>
<span class="nb">isinstance</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>  <span class="c1"># True</span>

<span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="s1">&#39;aabbbcccc&#39;</span><span class="p">:</span>
    <span class="n">counter</span><span class="p">[</span><span class="n">ch</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="k">print</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
<span class="c1"># Counter({&#39;c&#39;: 4, &#39;b&#39;: 3, &#39;a&#39;: 2})</span>
</pre></div>


<h3 id="base64">base64</h3>
<p>Base64是一种用64个字符来表示任意二进制数据的方法。</p>
<p>Base64的原理很简单，首先，准备一个包含64个字符的数组：</p>
<div class="hlcode"><pre><span></span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="o">...</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="o">...</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">,</span> <span class="o">...</span> <span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">]</span>
</pre></div>


<p>然后，对二进制数据进行处理，每3个字节一组，一共是 <code>3x8=24bit</code> ，划为4组，每组正好6个bit。</p>
<div class="hlcode"><pre><span></span><span class="o">#</span> <span class="n">b1</span>        <span class="n">b2</span>        <span class="n">b3</span>
  <span class="mi">1001</span> <span class="mi">0001</span> <span class="mi">0000</span> <span class="mi">0100</span> <span class="mi">1110</span> <span class="mi">1011</span>
<span class="o">#</span> <span class="n">n1</span>     <span class="n">n2</span>      <span class="n">n3</span>     <span class="n">n4</span>
</pre></div>


<p>这样我们得到4个数字作为索引，然后查表，获得相应的4个字符，就是编码后的字符串。</p>
<p>所以，Base64编码会把3字节的二进制数据编码为4字节的文本数据，长度增加33%，好处是编码后的文本数据可以在邮件正文、网页等直接显示。</p>
<p>如果要编码的二进制数据不是3的倍数，最后会剩下1个或2个字节怎么办？Base64用 <code>\x00</code> 字节在末尾补足后，再在编码的末尾加上1个或2个 <code>=</code> 号，表示补了多少字节，解码的时候，会自动去掉。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">base64</span>

<span class="n">encoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>  <span class="c1"># b&#39;aGVsbG8=&#39;</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">encoded</span><span class="p">))</span>  <span class="c1"># &lt;class &#39;bytes&#39;&gt;</span>

<span class="n">decoded</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">encoded</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>  <span class="c1"># b&#39;hello&#39;</span>
<span class="k">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">decoded</span><span class="p">))</span>  <span class="c1"># &lt;class &#39;bytes&#39;&gt;</span>
<span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">decoded</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>  <span class="c1"># hello</span>
</pre></div>


<p>由于标准的Base64编码后可能出现字符 <code>+</code> 和 <code>/</code> ，在URL中就不能直接作为参数，所以又有一种"url safe"的base64编码，其实就是把字符 <code>+</code> 和 <code>/</code> 分别变成 <code>-</code>和 <code>_</code>:</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">base64</span>

<span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;i</span><span class="se">\xb7\x1d\xfb\xef\xff</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># b&#39;abcd++//&#39;</span>
<span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;i</span><span class="se">\xb7\x1d\xfb\xef\xff</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># b&#39;abcd--__&#39;</span>
<span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="s1">&#39;abcd--__&#39;</span><span class="p">)</span>
<span class="c1"># b&#39;i\xb7\x1d\xfb\xef\xff&#39;</span>
</pre></div>


<p>还可以自己定义64个字符的排列顺序，这样就可以自定义Base64编码</p>
<p>Base64是一种通过查表的编码方法， <strong>不能用于加密，即使使用自定义的编码表也不行</strong> 。（破解难度太低）</p>
<p>Base64适用于小段内容的编码，比如数字证书签名、Cookie的内容等。</p>
<p>由于 <code>=</code> 字符也可能出现在Base64编码中，但 <code>=</code> 用在URL、Cookie里面会造成歧义，所以，很多Base64编码后会把 <code>=</code> 去掉。去掉 <code>=</code> 后怎么解码呢？因为Base64是把3个字节变为4个字节，所以，Base64编码的长度永远是4的倍数，因此，需要加上 <code>=</code> 把Base64字符串的长度变为4的倍数，就可以正常解码了。</p>
<h3 id="struct">struct</h3>
<p>Python提供了一个struct模块来解决bytes和其他二进制数据类型的转换。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">struct</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="mi">10240099</span><span class="p">)</span>
<span class="c1"># b&#39;\x00\x9c@c&#39;</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;&gt;I&#39;</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c1"># (10240099,)</span>
</pre></div>


<p><code>pack</code> 的第一个参数是处理指令，<code>'&gt;I'</code> 的意思是：</p>
<ul>
<li><code>&gt;</code>: 字节顺序是big-endian，也就是网络序</li>
<li><code>I</code>: 表示4字节无符号整数</li>
</ul>
<p><code>unpack</code> 把bytes变成相应的数据类型。</p>
<h3 id="hashlib">hashlib</h3>
<p>Python的 <code>hashlib</code> 提供了常见的 Hash 算法（又称摘要算法），如MD5，SHA1等等。</p>
<p>Hash：通过一个函数，把 <strong>任意长度的数据</strong> 转换为一个 <strong>长度固定的数据串</strong> （通常用16进制的字符串表示）。</p>
<p>Hash 可以用来检查原始数据是否被人篡改过。</p>
<p>Hash 函数是一个单向函数，计算出 hash 值容易，反推很难。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">hashlib</span>

<span class="n">md5</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">()</span>
<span class="n">md5</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">md5</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">())</span>
<span class="c1"># 5eb63bbbe01eeed093cb22bb8f5acdc3</span>
</pre></div>


<p>如果数据量很大，可以分块多次调用 <code>update()</code> ，最后计算的结果是一样的。</p>
<p>MD5是最常见的摘要算法，速度很快，生成结果是固定的128 bit字节，通常用一个32位的16进制字符串表示。</p>
<p>另一种常见的摘要算法是SHA1，<code>hashlib.sha1()</code>。</p>
<p>SHA1的结果是160 bit字节，通常用一个40位的16进制字符串表示。</p>
<p>比SHA1更安全的算法是SHA256和SHA512，不过越安全的算法不仅越慢，而且摘要长度更长。</p>
<p>有没有可能两个不同的数据通过某个摘要算法得到了相同的摘要？完全有可能，因为任何摘要算法都是把无限多的数据集合映射到一个有限的集合中。这种情况称为碰撞。</p>
<p>一个摘要算法的例子，网站数据库不应该明文保存用户密码，而应该存储用户密码的哈希值，当用户登录时，首先计算用户输入的明文口令的MD5，然后和数据库存储的MD5对比，如果一致，说明口令输入正确，如果不一致，口令肯定错误。</p>
<p>假设你是一个黑客，已经拿到了存储MD5口令的数据库，如何通过MD5反推用户的明文口令呢？暴力破解费事费力，真正的黑客不会这么干。</p>
<p>很多用户喜欢用123456，888888，password这些简单的口令，于是，黑客可以事先计算出这些常用口令的MD5值，得到一个反推表：</p>
<div class="hlcode"><pre><span></span><span class="s1">&#39;e10adc3949ba59abbe56e057f20f883e&#39;</span><span class="p">:</span> <span class="s1">&#39;123456&#39;</span>
<span class="s1">&#39;21218cca77804d2ba1922c33e0151105&#39;</span><span class="p">:</span> <span class="s1">&#39;888888&#39;</span>
<span class="s1">&#39;5f4dcc3b5aa765d61d8327deb882cf99&#39;</span><span class="p">:</span> <span class="s1">&#39;password&#39;</span>
</pre></div>


<p>这样，无需破解，只需要对比数据库的MD5，黑客就获得了使用常用口令的用户账号。</p>
<p>由于常用口令的MD5值很容易被计算出来，所以，要确保存储的用户口令不是那些已经被计算出来的常用口令的MD5，这一方法通过对原始口令加一个复杂字符串来实现，俗称“加盐”：</p>
<div class="hlcode"><pre><span></span><span class="k">def</span> <span class="nf">calc_md5</span><span class="p">(</span><span class="n">password</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">get_md5</span><span class="p">(</span><span class="n">password</span> <span class="o">+</span> <span class="s1">&#39;the-Salt&#39;</span><span class="p">)</span>
</pre></div>


<p>但是如果有两个用户都使用了相同的简单口令比如123456，在数据库中，将存储两条相同的MD5值，这说明这两个用户的口令是一样的。有没有办法让使用相同口令的用户存储不同的MD5呢？</p>
<p>如果假定用户无法修改登录名，就可以通过把登录名作为Salt的一部分来计算MD5，从而实现相同口令的用户也存储不同的MD5。</p>
<h3 id="hmac">hmac</h3>
<p>为了防止黑客通过彩虹表（rainbow table）根据哈希值反推原始口令，在计算哈希的时候，不能仅针对原始输入计算，需要增加一个salt来使得相同的输入也能得到不同的哈希，这样，大大增加了黑客破解的难度。</p>
<p>Hmac算法：Keyed-Hashing for Message Authentication。它通过一个标准算法，在计算哈希的过程中，把key混入计算过程中。要验证哈希值，必须同时提供正确的口令(key)。</p>
<p>和我们自定义的加salt算法不同，Hmac算法针对所有哈希算法都通用，无论是MD5还是SHA-1。采用Hmac替代我们自己的salt算法，可以使程序算法更标准化，也更安全。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">hmac</span>
<span class="n">message</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;Hello, world!&#39;</span>
<span class="n">key</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;secret&#39;</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">hmac</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">digestmod</span><span class="o">=</span><span class="s1">&#39;MD5&#39;</span><span class="p">)</span>
<span class="c1"># 如果消息很长，可以多次调用h.update(msg)</span>
<span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
<span class="c1"># &#39;fa4ee7d173f2d97ee79022d1a7355bcf&#39;</span>
</pre></div>


<h3 id="itertools">itertools</h3>
<p><code>itertools</code> 提供了非常有用的用于操作迭代对象的函数。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">itertools</span>

<span class="c1"># 无限的迭代</span>
<span class="n">natuals</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">natuals</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># cycle()会把传入的一个序列无限重复下去：</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">cycle</span><span class="p">(</span><span class="s1">&#39;ABC&#39;</span><span class="p">)</span>  <span class="c1"># 注意字符串也是序列的一种</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cs</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="c1"># repeat()负责把一个元素无限重复下去，不过如果提供第二个参数就可以限定重复次数：</span>
<span class="n">ns</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="c1"># 通常我们会通过takewhile()等函数根据条件判断来截取出一个有限的序列：</span>
<span class="n">natuals</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ns</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">takewhile</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">natuals</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">ns</span><span class="p">))</span>
<span class="c1"># [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</span>

<span class="c1"># chain()可以把一组迭代对象串联起来，形成一个更大的迭代器：</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="s1">&#39;ABC&#39;</span><span class="p">,</span> <span class="s1">&#39;XYZ&#39;</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
<span class="c1"># 迭代效果：&#39;A&#39; &#39;B&#39; &#39;C&#39; &#39;X&#39; &#39;Y&#39; &#39;Z&#39;</span>

<span class="c1"># groupby()把迭代器中相邻的重复元素挑出来放在一起：</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;AAABBBCCAAA&#39;</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A [&#39;A&#39;, &#39;A&#39;, &#39;A&#39;]</span>
<span class="sd">B [&#39;B&#39;, &#39;B&#39;, &#39;B&#39;]</span>
<span class="sd">C [&#39;C&#39;, &#39;C&#39;]</span>
<span class="sd">A [&#39;A&#39;, &#39;A&#39;, &#39;A&#39;]</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># groupby 支持传入一个求 key 值的函数，比如我们可以忽略大小写：</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;AaaBBbcCAAa&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A [&#39;A&#39;, &#39;a&#39;, &#39;a&#39;]</span>
<span class="sd">B [&#39;B&#39;, &#39;B&#39;, &#39;b&#39;]</span>
<span class="sd">C [&#39;c&#39;, &#39;C&#39;]</span>
<span class="sd">A [&#39;A&#39;, &#39;A&#39;, &#39;a&#39;]</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>


<h3 id="contextlib">contextlib</h3>
<p>在Python中，读写文件这样的资源要特别注意，必须在使用完毕后正确关闭它们。正确关闭文件资源的一个方法是使用 <code>try...finally</code> ：</p>
<div class="hlcode"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/path/to/file&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>Python的 <code>with</code> 语句允许我们非常方便地使用资源，而不必担心资源没有关闭，所以上面的代码可以简化为：</p>
<p><code>``python</code><br />
with open('/path/to/file', 'r') as f:<br />
    f.read()</p>
<div class="hlcode"><pre><span></span>任何对象，只要正确实现了 <span class="o">**</span>上下文管理<span class="o">**</span> ，就可以用于 `<span class="nv">with</span>` 语句。

实现上下文管理是通过 `<span class="nv">__enter__</span>` 和 `<span class="nv">__exit__</span>` 这两个方法实现的。例如，下面的<span class="nv">class</span>实现了这两个方法：

```<span class="nv">python</span>
<span class="nv">class</span> <span class="nv">Query</span><span class="ss">(</span><span class="nv">object</span><span class="ss">)</span>:

    <span class="nv">def</span> <span class="nv">__init__</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">name</span><span class="ss">)</span>:
        <span class="nv">self</span>.<span class="nv">name</span> <span class="o">=</span> <span class="nv">name</span>

    <span class="nv">def</span> <span class="nv">__enter__</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="nv">print</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">Begin</span><span class="s1">&#39;</span><span class="ss">)</span>
        <span class="k">return</span> <span class="nv">self</span>

    <span class="nv">def</span> <span class="nv">__exit__</span><span class="ss">(</span><span class="nv">self</span>, <span class="nv">exc_type</span>, <span class="nv">exc_value</span>, <span class="nv">traceback</span><span class="ss">)</span>:
        <span class="k">if</span> <span class="nv">exc_type</span>:
            <span class="nv">print</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">Error</span><span class="s1">&#39;</span><span class="ss">)</span>
        <span class="k">else</span>:
            <span class="nv">print</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">End</span><span class="s1">&#39;</span><span class="ss">)</span>

    <span class="nv">def</span> <span class="nv">query</span><span class="ss">(</span><span class="nv">self</span><span class="ss">)</span>:
        <span class="nv">print</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">Query info about %s...</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nv">self</span>.<span class="nv">name</span><span class="ss">)</span>


# 把自己写的资源对象用于<span class="nv">with</span>语句：
<span class="nv">with</span> <span class="nv">Query</span><span class="ss">(</span><span class="s1">&#39;</span><span class="s">Alice</span><span class="s1">&#39;</span><span class="ss">)</span> <span class="nv">as</span> <span class="nv">q</span>:
    <span class="nv">q</span>.<span class="nv">query</span><span class="ss">()</span>
</pre></div>


<h4 id="contextmanager">@contextmanager</h4>
<p>编写 <code>__enter__</code> 和 <code>__exit__</code> 仍然很繁琐，因此Python的标准库 <code>contextlib</code> 提供了更简单的写法，上面的代码可以改写如下：</p>
<div class="hlcode"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="k">class</span> <span class="nc">Query</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Query info about </span><span class="si">%s</span><span class="s1">...&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="c1"># @contextmanager这个decorator接受一个generator，</span>
<span class="c1"># 用yield语句把with ... as var把变量输出出去，</span>
<span class="c1"># 然后，with语句就可以正常地工作了：</span>
<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">create_query</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Begin&#39;</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">Query</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">yield</span> <span class="n">q</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;End&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">create_query</span><span class="p">(</span><span class="s1">&#39;Bob&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">q</span><span class="p">:</span>
    <span class="n">q</span><span class="o">.</span><span class="n">query</span><span class="p">()</span>
</pre></div>


<p>很多时候，我们希望在某段代码执行前后自动执行特定代码，也可以用@contextmanager实现。例如：</p>
<div class="hlcode"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">tag</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">yield</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;&lt;/</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tag</span><span class="p">(</span><span class="s2">&quot;h1&quot;</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;world&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&lt;h1&gt;</span>
<span class="sd">hello</span>
<span class="sd">world</span>
<span class="sd">&lt;/h1&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>


<h4 id="closing">@closing</h4>
<p>如果一个对象没有实现上下文，我们就不能把它用于 <code>with</code> 语句。这个时候，可以用 <code>closing()</code> 来把该对象变为上下文对象。例如，用 <code>with</code> 语句使用 <code>urlopen()</code> ：</p>
<div class="hlcode"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">urllib.request</span> <span class="kn">import</span> <span class="n">urlopen</span>

<span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">urlopen</span><span class="p">(</span><span class="s1">&#39;https://www.python.org&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">page</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">page</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</pre></div>


<p><code>closing</code> 也是一个经过@contextmanager装饰的generator，这个generator编写起来其实非常简单：</p>
<div class="hlcode"><pre><span></span><span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">closing</span><span class="p">(</span><span class="n">thing</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">thing</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">thing</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>


<p>它的作用就是把任意对象变为上下文对象，并支持 <code>with</code> 语句。</p>
<h3 id="urllib">urllib</h3>
<p>urllib提供了一系列用于操作URL的功能。</p>
<h4 id="get">Get</h4>
<p>urllib的 <code>request</code> 模块可以非常方便地抓取URL内容，也就是发送一个GET请求到指定的页面，然后返回HTTP的响应：</p>
<div class="hlcode"><pre><span></span><span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span>

<span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s1">&#39;https://api.douban.com/v2/book/2129650&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Status:&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">getheaders</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Data:&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</pre></div>


<p>如果我们要想模拟浏览器发送GET请求，就需要使用<code>Request</code>对象，通过往<code>Request</code>对象添加HTTP头，我们就可以把请求伪装成浏览器。例如，模拟iPhone 6去请求豆瓣首页：</p>
<div class="hlcode"><pre><span></span><span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s1">&#39;http://www.douban.com/&#39;</span><span class="p">)</span>
<span class="c1"># 添加HTTP头</span>
<span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">,</span> <span class="s1">&#39;Mozilla/6.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/8.0 Mobile/10A5376e Safari/8536.25&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Status:&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">getheaders</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Data:&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</pre></div>


<h4 id="post">Post</h4>
<p>如果要以POST发送一个请求，只需要把 <code>urlopen</code> 的参数 <code>data</code> 以bytes形式传入。</p>
<div class="hlcode"><pre><span></span><span class="kn">from</span> <span class="nn">urllib</span> <span class="kn">import</span> <span class="n">request</span><span class="p">,</span> <span class="n">parse</span>

<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Login to weibo.cn...&#39;</span><span class="p">)</span>
<span class="n">email</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Email: &#39;</span><span class="p">)</span>
<span class="n">passwd</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;Password: &#39;</span><span class="p">)</span>
<span class="n">login_data</span> <span class="o">=</span> <span class="n">parse</span><span class="o">.</span><span class="n">urlencode</span><span class="p">([</span>
    <span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="n">email</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="n">passwd</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;entry&#39;</span><span class="p">,</span> <span class="s1">&#39;mweibo&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;client_id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;savestate&#39;</span><span class="p">,</span> <span class="s1">&#39;1&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ec&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;pagerefer&#39;</span><span class="p">,</span> <span class="s1">&#39;https://passport.weibo.cn/signin/welcome?entry=mweibo&amp;r=http%3A</span><span class="si">%2F%2F</span><span class="s1">m.weibo.cn</span><span class="si">%2F</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="s1">&#39;https://passport.weibo.cn/sso/login&#39;</span><span class="p">)</span>
<span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;https://passport.weibo.cn&#39;</span><span class="p">)</span>
<span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">,</span> <span class="s1">&#39;Mozilla/6.0 (iPhone; CPU iPhone OS 8_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/8.0 Mobile/10A5376e Safari/8536.25&#39;</span><span class="p">)</span>
<span class="n">req</span><span class="o">.</span><span class="n">add_header</span><span class="p">(</span><span class="s1">&#39;Referer&#39;</span><span class="p">,</span> <span class="s1">&#39;https://passport.weibo.cn/signin/login?entry=mweibo&amp;res=wel&amp;wm=3349&amp;r=http%3A</span><span class="si">%2F%2F</span><span class="s1">m.weibo.cn</span><span class="si">%2F</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># 传入 data 参数</span>
<span class="k">with</span> <span class="n">request</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">login_data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Status:&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">status</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">reason</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">getheaders</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Data:&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</pre></div>


<h4 id="handler">Handler</h4>
<p>如果还需要更复杂的控制，比如通过一个Proxy去访问网站，我们需要利用ProxyHandler来处理，示例代码如下：</p>
<div class="hlcode"><pre><span></span><span class="n">proxy_handler</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">ProxyHandler</span><span class="p">({</span><span class="s1">&#39;http&#39;</span><span class="p">:</span> <span class="s1">&#39;http://www.example.com:3128/&#39;</span><span class="p">})</span>
<span class="n">proxy_auth_handler</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">ProxyBasicAuthHandler</span><span class="p">()</span>
<span class="n">proxy_auth_handler</span><span class="o">.</span><span class="n">add_password</span><span class="p">(</span><span class="s1">&#39;realm&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>
<span class="n">opener</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">build_opener</span><span class="p">(</span><span class="n">proxy_handler</span><span class="p">,</span> <span class="n">proxy_auth_handler</span><span class="p">)</span>
<span class="k">with</span> <span class="n">opener</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;http://www.example.com/login.html&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>


<h3 id="xml">xml</h3>
<p>XML比JSON复杂，在Web中应用也不如以前多，不过仍有很多地方在用。</p>
<p>操作XML有两种方法：DOM和SAX。DOM会把整个XML读入内存，解析为树，因此占用内存大，解析慢，优点是可以任意遍历树的节点。SAX是流模式，边读边解析，占用内存小，解析快，缺点是我们需要自己处理事件。</p>
<p>正常情况下，优先考虑SAX，因为DOM实在太占内存。</p>
<p>在Python中使用SAX解析XML非常简洁，通常我们关心的事件是 <code>start_element</code>，<code>end_element</code> 和 <code>char_data</code> ，准备好这3个函数，然后就可以解析xml了。</p>
<p>举个例子，当SAX解析器读到一个节点时：</p>
<div class="hlcode"><pre><span></span><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>python<span class="nt">&lt;/a&gt;</span>
</pre></div>


<p>会产生3个事件：</p>
<ol>
<li>start_element事件，在读取<a href="/">时；</li>
<li>char_data事件，在读取python时；</li>
<li>end_element事件，在读取</a>时。</li>
</ol>
<div class="hlcode"><pre><span></span><span class="kn">from</span> <span class="nn">xml.parsers.expat</span> <span class="kn">import</span> <span class="n">ParserCreate</span>

<span class="k">class</span> <span class="nc">DefaultSaxHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">start_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;sax:start_element: </span><span class="si">%s</span><span class="s1">, attrs: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">attrs</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">end_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;sax:end_element: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">char_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;sax:char_data: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">text</span><span class="p">)</span>

<span class="n">xml</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;&#39;&#39;&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="s1">&lt;ol&gt;</span>
<span class="s1">    &lt;li&gt;&lt;a href=&quot;/python&quot;&gt;Python&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">    &lt;li&gt;&lt;a href=&quot;/ruby&quot;&gt;Ruby&lt;/a&gt;&lt;/li&gt;</span>
<span class="s1">&lt;/ol&gt;</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">handler</span> <span class="o">=</span> <span class="n">DefaultSaxHandler</span><span class="p">()</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">ParserCreate</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">StartElementHandler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">start_element</span>
<span class="n">parser</span><span class="o">.</span><span class="n">EndElementHandler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">end_element</span>
<span class="n">parser</span><span class="o">.</span><span class="n">CharacterDataHandler</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">char_data</span>
<span class="n">parser</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">xml</span><span class="p">)</span>
</pre></div>


<p>解析XML时，找出自己感兴趣的节点，响应事件时，把节点数据保存起来。解析完毕后，就可以处理数据。</p>
<h3 id="htmlparser">HTMLParser</h3>
<p>Python提供了HTMLParser来非常方便地解析HTML，只需简单几行代码：</p>
<div class="hlcode"><pre><span></span><span class="kn">from</span> <span class="nn">html.parser</span> <span class="kn">import</span> <span class="n">HTMLParser</span>
<span class="kn">from</span> <span class="nn">html.entities</span> <span class="kn">import</span> <span class="n">name2codepoint</span>

<span class="k">class</span> <span class="nc">MyHTMLParser</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&lt;/</span><span class="si">%s</span><span class="s1">&gt;&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_startendtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&lt;</span><span class="si">%s</span><span class="s1">/&gt;&#39;</span> <span class="o">%</span> <span class="n">tag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&lt;!--&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="s1">&#39;--&gt;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_entityref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&amp;</span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">handle_charref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;&amp;#</span><span class="si">%s</span><span class="s1">;&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">MyHTMLParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;&lt;html&gt;</span>
<span class="s1">&lt;head&gt;&lt;/head&gt;</span>
<span class="s1">&lt;body&gt;</span>
<span class="s1">&lt;!-- test html parser --&gt;</span>
<span class="s1">    &lt;p&gt;Some &lt;a href=</span><span class="se">\&quot;</span><span class="s1">#</span><span class="se">\&quot;</span><span class="s1">&gt;html&lt;/a&gt; HTML&amp;nbsp;tutorial...&lt;br&gt;END&lt;/p&gt;</span>
<span class="s1">&lt;/body&gt;&lt;/html&gt;&#39;&#39;&#39;</span><span class="p">)</span>
</pre></div>


<p>利用HTMLParser，可以把网页中的文本、图像等解析出来。</p>
<hr />
<h2 id="_4">常用第三方模块</h2>
<h3 id="pillow">Pillow</h3>
<p>PIL：Python Imaging Library，已经是Python平台事实上的图像处理标准库了。PIL功能非常强大，但API却非常简单易用。</p>
<p>由于PIL仅支持到Python 2.7，加上年久失修，于是一群志愿者在PIL的基础上创建了兼容的版本，名字叫Pillow，支持最新Python 3.x，又加入了许多新特性，因此，我们可以直接安装使用Pillow。</p>
<p>安装：</p>
<div class="hlcode"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">pillow</span>
</pre></div>


<p>常用操作：</p>
<div class="hlcode"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>

<span class="c1"># 打开一个jpg图像文件，注意是当前路径:</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;test.jpg&#39;</span><span class="p">)</span>

<span class="c1"># 获得图像尺寸:</span>
<span class="n">w</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Original image size: </span><span class="si">%s</span><span class="s1">x</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">))</span>

<span class="c1"># 缩放到50%:</span>
<span class="n">im</span><span class="o">.</span><span class="n">thumbnail</span><span class="p">((</span><span class="n">w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="s1">&#39;Resize image to: </span><span class="si">%s</span><span class="s1">x</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="o">//</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># 把缩放后的图像用jpeg格式保存:</span>
<span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;thumbnail.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">)</span>

<span class="c1"># PIL 中提供了一些图像 filter</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">ImageFilter</span>

<span class="c1"># 应用模糊滤镜:</span>
<span class="n">im2</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ImageFilter</span><span class="o">.</span><span class="n">BLUR</span><span class="p">)</span>
</pre></div>


<p>PIL的 <code>ImageDraw</code> 提供了一系列绘图方法，让我们可以直接绘图。比如要生成字母验证码图片：</p>
<div class="hlcode"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span><span class="p">,</span> <span class="n">ImageFont</span><span class="p">,</span> <span class="n">ImageFilter</span>

<span class="kn">import</span> <span class="nn">random</span>

<span class="c1"># 随机字母:</span>
<span class="k">def</span> <span class="nf">rndChar</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">chr</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">65</span><span class="p">,</span> <span class="mi">90</span><span class="p">))</span>

<span class="c1"># 随机颜色1:</span>
<span class="k">def</span> <span class="nf">rndColor</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">255</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>

<span class="c1"># 随机颜色2:</span>
<span class="k">def</span> <span class="nf">rndColor2</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">127</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">127</span><span class="p">),</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">127</span><span class="p">))</span>

<span class="c1"># 240 x 60:</span>
<span class="n">width</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">4</span>
<span class="n">height</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">),</span> <span class="p">(</span><span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">))</span>
<span class="c1"># 创建Font对象:</span>
<span class="n">font</span> <span class="o">=</span> <span class="n">ImageFont</span><span class="o">.</span><span class="n">truetype</span><span class="p">(</span><span class="s1">&#39;Arial.ttf&#39;</span><span class="p">,</span> <span class="mi">36</span><span class="p">)</span>
<span class="c1"># 创建Draw对象:</span>
<span class="n">draw</span> <span class="o">=</span> <span class="n">ImageDraw</span><span class="o">.</span><span class="n">Draw</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
<span class="c1"># 填充每个像素:</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="n">draw</span><span class="o">.</span><span class="n">point</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">fill</span><span class="o">=</span><span class="n">rndColor</span><span class="p">())</span>
<span class="c1"># 输出文字:</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">draw</span><span class="o">.</span><span class="n">text</span><span class="p">((</span><span class="mi">60</span> <span class="o">*</span> <span class="n">t</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">rndChar</span><span class="p">(),</span> <span class="n">font</span><span class="o">=</span><span class="n">font</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="n">rndColor2</span><span class="p">())</span>
<span class="c1"># 模糊:</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">ImageFilter</span><span class="o">.</span><span class="n">BLUR</span><span class="p">)</span>
<span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;code.jpg&#39;</span><span class="p">,</span> <span class="s1">&#39;jpeg&#39;</span><span class="p">)</span>
</pre></div>


<h3 id="requests">requests</h3>
<p><code>requests</code> 是一个Python第三方库，处理URL资源比内置的 <code>urllib</code> 强大。</p>
<div class="hlcode"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">requests</span>
</pre></div>


<p>要通过GET访问一个页面，只需要几行代码：</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://www.douban.com/&#39;</span><span class="p">)</span> <span class="c1"># 豆瓣首页</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
<span class="c1"># 200</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">&#39;&lt;!DOCTYPE HTML&gt;\\n&lt;html&gt;\\n&lt;head&gt;\\n&lt;meta name=&quot;description&quot; content=&quot;提供图书、电影、音乐唱片的推荐、评论和...&#39;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="k">print</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>
<span class="c1"># &#39;utf-8&#39;</span>
</pre></div>


<h3 id="chardet">chardet</h3>
<p>在处理一些不规范的第三方网页的时候，如果不知道字符串编码，会很难处理。</p>
<p><code>chardet</code> 用于检测编码，简单实用。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">chardet</span>

<span class="n">chardet</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, world!&#39;</span><span class="p">)</span>
<span class="c1"># {&#39;encoding&#39;: &#39;ascii&#39;, &#39;confidence&#39;: 1.0, &#39;language&#39;: &#39;&#39;}</span>
</pre></div>


<h3 id="psutil">psutil</h3>
<p>在Linux下，有许多系统命令可以让我们时刻监控系统运行的状态，如ps，top，free等等。要获取这些系统信息，Python可以通过 <code>subprocess</code> 模块调用并获取结果。但这样做显得很麻烦，尤其是要写很多解析代码。</p>
<p>psutil = process and system utilities，这个第三方模块可以通过一两行代码实现系统监控，还可以跨平台使用。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">psutil</span>

<span class="c1"># 获取 CPU 信息</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="c1"># CPU逻辑数量</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(</span><span class="n">logical</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1"># CPU物理核心</span>

<span class="c1"># 统计CPU的用户／系统／空闲时间：</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">cpu_times</span><span class="p">()</span>

<span class="c1"># 实现类似top命令的CPU使用率，每秒刷新一次，累计10次：</span>
<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">psutil</span><span class="o">.</span><span class="n">cpu_percent</span><span class="p">(</span><span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">percpu</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="c1"># 获取内存信息</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span> <span class="c1"># 物理内存</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">swap_memory</span><span class="p">()</span>  <span class="c1"># 交换内存</span>

<span class="c1"># 获取磁盘信息</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">disk_partitions</span><span class="p">()</span> <span class="c1"># 磁盘分区信息</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">disk_usage</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="c1"># 磁盘使用情况</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">disk_io_counters</span><span class="p">()</span> <span class="c1"># 磁盘IO</span>

<span class="c1"># 获取网络信息</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">net_io_counters</span><span class="p">()</span> <span class="c1"># 获取网络读写字节／包的个数</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">net_if_stats</span><span class="p">()</span> <span class="c1"># 获取网络接口状态</span>

<span class="c1"># 获取进程信息</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">pids</span><span class="p">()</span> <span class="c1"># 所有进程ID</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="mi">3776</span><span class="p">)</span> <span class="c1"># 获取指定进程ID=3776</span>
</pre></div>


<p>psutil还提供了一个 <code>test()</code> 函数，可以模拟出 <code>ps</code> 命令的效果。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">psutil</span>
<span class="n">psutil</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
</pre></div>
  <div class="relation">
    <h2>Related</h2>
    <ul>
    
    <li><a href="/wiki/tools/anaconda_python_notes.html">Anaconda notes</a></li>
    
    <li><a href="/wiki/python/python_oop.html">Python 面向对象编程</a></li>
    
    <li><a href="/wiki/python/python_database.html">Python 数据库访问</a></li>
    
    <li><a href="/wiki/python/python_network_programming.html">Python 网络编程</a></li>
    
    <li><a href="/wiki/python/python_basics_notes.html">Python Basics Notes</a></li>
    
    <li><a href="/wiki/python/python_re.html">Python 正则表达式</a></li>
    
    <li><a href="/wiki/python/python_email.html">Python 收发电子邮件</a></li>
    
    <li><a href="/wiki/python/python_web_development.html">Python Web 开发</a></li>
    
    <li><a href="/wiki/python/python_debugging_and_tests.html">Python 错误处理与测试</a></li>
    
    <li><a href="/wiki/python/python_fp_notes.html">Python 函数式编程</a></li>
    
    <li><a href="/wiki/python/python_process_thread_and_async_io.html">Python 进程、线程与异步IO</a></li>
    
    <li><a href="/wiki/python/python_IO.html">Python IO 编程</a></li>
    
    </ul>
  </div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 Yilin Gui.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-06-24 02:04:06</p>
      </span>
    </div>

    
    
  </body>
</html>